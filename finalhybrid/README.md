# 基于混合图神经网络的分子属性预测系统

本项目实现了一个混合图神经网络(GNN)模型，用于从分子的SMILES表示预测多个分子属性（特别是5个药物靶点的pIC50值）。该模型结合了分子图结构和传统分子描述符，以提高预测准确性。

## 目录
- [概述](#概述)
- [模型架构](#模型架构)
- [功能特性](#功能特性)
- [安装说明](#安装说明)
- [使用方法](#使用方法)
- [项目结构](#项目结构)
- [训练结果](#训练结果)
- [许可证](#许可证)

## 概述

本项目旨在使用混合图神经网络方法预测小分子对多个药物靶点的生物活性（pIC50值）。模型以SMILES字符串作为输入，将其转换为分子图，并结合传统分子描述符，通过多任务学习方法同时预测多个靶点的活性。

主要应用领域：
- 药物发现与开发
- 化合物库虚拟筛选
- 药物化学中的先导化合物优化

## 模型架构

混合模型架构结合了图神经网络和传统分子描述符，以增强分子属性预测效果：

### 混合特征提取
- **图神经网络路径**：从分子图中提取结构特征
- **分子描述符路径**：处理传统的分子属性（分子量MolWt、脂水分配系数LogP、氢键受体HBA、氢键供体HBD）
- **特征融合**：将两种特征集进行组合以进行最终预测

### 图神经网络主干
- **GCN层**：图卷积层，用于学习局部结构特征
- **GAT层**：图注意力层，用于自适应特征加权
- **残差连接**：使训练更深的网络成为可能
- **注意力池化**：学习对属性预测重要的原子

### 多任务学习
- **共享GNN主干**：提取共同的分子特征
- **任务特定头部**：为每个目标独立预测头部
- **特征融合**：将图特征与分子描述符结合

### 详细架构流程
1. **输入处理**：
   - 使用RDKit将SMILES字符串转换为分子图
   - 节点特征：原子类型、电荷、度数、价态、芳香性、杂化等（36个特征）
   - 边特征：键类型、立体化学、共轭、环成员资格（10个特征）
   - 分子描述符：分子量(MolWt)、LogP、氢键受体(HBA)、氢键供体(HBD)

2. **GNN层**：
   - 多层GCN和GAT
   - 每层结合图卷积与注意力机制
   - 层间有残差连接和dropout

3. **图池化**：
   - 基于注意力的池化以识别重要原子
   - 平均、最大和求和池化以获得互补表示
   - 连接所有池化结果

4. **特征融合**：
   - 图特征与分子描述符连接
   - 共享MLP处理组合特征
   - 每个目标的任务特定头部

5. **预测头部**：
   - 共享MLP处理池化后的图表示
   - 每个目标的任务特定预测头部
   - 每个头部包含多个全连接层，带有归一化和dropout

## 功能特性

- **混合架构**：结合GNN与传统分子描述符
- **多任务学习**：同时预测5个目标任务
- **注意力机制**：突出重要的分子亚结构
- **残差连接**：实现更深更有效的网络
- **全面评估**：使用RMSE、MAE、R²等多种指标评估模型性能
- **早停机制**：防止训练过程中的过拟合
- **实验追踪**：自动记录训练历史和模型检查点

## 安装说明

### 环境要求
- Python 3.8+
- 推荐使用Conda环境管理

### 环境配置

```bash
# 创建并激活conda环境
conda create -n finalhybrid python=3.8
conda activate finalhybrid

# 安装所需包
pip install torch rdkit-pypi networkx pandas numpy scikit-learn matplotlib
```

注意：PyTorch Geometric的安装请参考官方指南：https://pytorch-geometric.readthedocs.io/en/latest/install/installation.html

## 使用方法

### 训练模型

```bash
# 运行训练脚本
python train_hybrid_final.py
```

训练脚本将执行以下操作：
1. 从`data/candidate_hybrid.csv`加载数据
2. 将数据分割为训练/验证/测试集（60%/20%/20%）
3. 创建并训练混合GNN模型
4. 将结果保存到`experiments/experiment_YYYYMMDD_HHMMSS/`

### 关键训练参数
- 训练轮数：30轮（启用早停机制）
- 批次大小：16
- 学习率：0.001
- 早停耐心值：20轮

### 数据格式

输入数据应为CSV格式，包含以下列：
- `SMILES`：分子结构的SMILES格式
- `target1_pIC50` 到 `target5_pIC50`：5个靶点的pIC50值
- `MolWt`, `LogP`, `HBA`, `HBD`：额外的分子描述符

## 项目结构

```
finalhybrid/
├── data/
│   └── candidate_hybrid.csv          # 训练数据
├── experiments/                      # 训练结果和日志
├── model/                            # 训练好的模型检查点
├── real_data/                        # 原始输入数据集
│   ├── activity_train.csv            # 目标活性数据
│   ├── molecule.smi                  # SMILES字符串
│   ├── property.csv                  # 分子描述符
│   └── candidate.csv                 # 待预测的候选分子
├── src/
│   ├── hybrid_model_final.py         # 模型架构定义
│   ├── smiles_to_graph.py            # SMILES到图的转换
│   ├── dataset_hybrid.py             # 数据集类
│   └── data_loader.py                # 数据加载工具
├── process_real_data.py              # 将原始数据处理为训练格式
├── train_hybrid_final.py             # 主训练脚本
├── evaluate_model.py                 # 模型评估
├── predict_candidates.py             # 对新候选分子进行预测
└── README.md                         # 本文档
```

## 训练结果

模型使用多种指标进行评估：
- **RMSE**（均方根误差）
- **MAE**（平均绝对误差）
- **R²**（决定系数）

注意：在小数据集（约160个样本）上，模型可能显示负R²值，表明预测性能较差。这是预期现象，可以通过更大的数据集来改善。

## 许可证

本项目仅供教育和研究目的使用。如果在学术工作中使用，请适当引用。